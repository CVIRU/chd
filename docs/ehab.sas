libname MIDAS 'R:\midaslab\DATA';
libname out 'C:\EDU\UMDNJ\EHAB';

%INCLUDE 'R:\midaslab\DATA\MIDAS format.sas';

/* admission level data */
DATA tmp (keep=PATIENT_ID STATUS SEX RACE2 AGE HISPAN HOSP CABG PCI ADMDAT BDYR NEWDTD STEMI NSTEMI CHD DX1-DX9); 
	SET MIDAS.midas19862014b;
		
	STEMI=0;
	NSTEMI=0;
	IHD=0; 
	IF '410' <=: SUBSTR(DX1,1,3) <= '414' THEN CHD = 1; ELSE CHD = 0;	
	IF SUBSTR(DX1, 1, 4) in ('4107') THEN NSTEMI=1; ELSE NSTEMI=0;
	IF SUBSTR(DX1, 1, 4) in ('4100','4101','4102','4103','4104','4105','4106','4108', '4109') THEN STEMI=1; ELSE  STEMI=0;

	ADMYR=year(ADMDAT);
	BDYR=year(PATBDTE);
	AGE=(ADMDAT-PATBDTE)/365.25;

	/* From Alice */
	IF RACE = '10025' THEN RACE2=3; /* native american*/
    ELSE IF RACE = '1' or RACE = '21063' THEN RACE2=1;
    ELSE IF RACE = '2' or RACE = '20545' THEN RACE2=2;
    ELSE RACE2=3;

	CABG=0;		PCI=0;
	ARRAY PROC{8} $ PROC1-PROC8;
	DO I = 1 TO 8;
		IF '3610' <=: PROC{i} <=: '3619' or PROC{i} =: '392' or PROC{i} =: 'V45.81' THEN CABG = 1 ;
		IF PROC{I} in ('0066', '3600', '3601', '3602', '3603', '3604', '3605', '3606', '3607','3608','3609') THEN PCI=1; 
	END;  
RUN;

DATA CHD;
	SET tmp;
	WHERE CHD=1;
RUN;

DATA CHD2;
	SET CHD;
	BY PATIENT_ID;
	RETAIN AGE_FST ADMYR_FST;
	IF FIRST.PATIENT_ID THEN
		DO
			AGE_FST=AGE;
			ADMYR_FST=ADMYR;
		END;
RUN;

DATA out.CHD3;
	SET CHD2;
	WHERE AGE_FST >= 40 and AGE_FST <= 99 and ADMYR_FST >= 1990 and ADMYR_FST <= 2014;
RUN;

	



	
